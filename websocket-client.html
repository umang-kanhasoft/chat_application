<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chat - Freelancer Platform</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .auth-container {
                background: white;
                padding: 40px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                max-width: 400px;
                width: 90%;
            }
            .auth-container h1 {
                color: #667eea;
                margin-bottom: 10px;
                font-size: 28px;
            }
            .auth-container p {
                color: #666;
                margin-bottom: 30px;
            }
            .auth-form {
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            input,
            select {
                padding: 12px 15px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                font-size: 14px;
                transition: all 0.3s;
            }
            input:focus,
            select:focus {
                outline: none;
                border-color: #667eea;
            }
            button {
                padding: 12px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: transform 0.2s;
            }
            button:hover {
                transform: translateY(-2px);
            }
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                transform: none;
            }

            .chat-container {
                display: none;
                width: 100vw;
                height: 100vh;
                background: #f0f2f5;
            }
            .chat-wrapper {
                display: grid;
                grid-template-columns: 350px 1fr;
                height: 100%;
            }
            .sidebar {
                background: white;
                border-right: 1px solid #e0e0e0;
                display: flex;
                flex-direction: column;
            }
            .sidebar-header {
                padding: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }
            .sidebar-header h2 {
                font-size: 20px;
                margin-bottom: 5px;
            }
            .sidebar-header p {
                font-size: 13px;
                opacity: 0.9;
            }
            .project-selector {
                padding: 15px;
                border-bottom: 1px solid #e0e0e0;
            }
            .project-selector select {
                width: 100%;
                padding: 10px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 14px;
            }
            .users-list {
                flex: 1;
                overflow-y: auto;
            }
            .user-item {
                padding: 15px 20px;
                border-bottom: 1px solid #f0f0f0;
                cursor: pointer;
                transition: background 0.2s;
                display: flex;
                align-items: center;
                gap: 12px;
                position: relative;
            }
            .user-item:hover {
                background: #f5f5f5;
            }
            .user-item.active {
                background: #e3f2fd;
                border-left: 4px solid #667eea;
            }
            .user-avatar {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 600;
                font-size: 18px;
                flex-shrink: 0;
                position: relative;
            }
            .online-dot {
                position: absolute;
                bottom: 2px;
                right: 2px;
                width: 12px;
                height: 12px;
                background: #44b700;
                border: 2px solid white;
                border-radius: 50%;
            }
            .user-info {
                flex: 1;
                min-width: 0;
            }
            .user-name {
                font-weight: 600;
                color: #333;
                margin-bottom: 3px;
            }
            .user-status {
                font-size: 12px;
                color: #44b700;
            }
            .user-status.offline {
                color: #999;
            }
            .unread-badge {
                position: absolute;
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
                background: #25d366;
                color: white;
                border-radius: 12px;
                padding: 2px 8px;
                font-size: 12px;
                font-weight: 600;
                min-width: 20px;
                text-align: center;
            }

            .chat-area {
                display: flex;
                flex-direction: column;
                background: #e5ddd5;
            }
            .chat-header {
                padding: 15px 25px;
                background: white;
                border-bottom: 1px solid #e0e0e0;
                display: flex;
                align-items: center;
                gap: 12px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }
            .chat-header .user-avatar {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            .chat-header-info h3 {
                font-size: 16px;
                color: #333;
                margin-bottom: 2px;
            }
            .chat-header-info p {
                font-size: 12px;
                color: #44b700;
            }
            .chat-header-info p.offline {
                color: #999;
            }
            .messages-container {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            .message {
                max-width: 65%;
                padding: 10px 14px;
                border-radius: 12px;
                word-wrap: break-word;
                animation: slideIn 0.3s;
            }
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .message.sent {
                background: #dcf8c6;
                align-self: flex-end;
                border-bottom-right-radius: 4px;
            }
            .message.received {
                background: white;
                align-self: flex-start;
                border-bottom-left-radius: 4px;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
            .message-content {
                color: #333;
                font-size: 14px;
                line-height: 1.4;
            }
            .message-footer {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 4px;
                gap: 8px;
            }
            .message-time {
                font-size: 11px;
                color: #999;
            }
            .message-status {
                font-size: 14px;
                color: #999;
            }
            .message-status.read {
                color: #4fc3f7;
            }
            .typing-indicator {
                padding: 10px 25px;
                font-size: 13px;
                color: #667eea;
                font-style: italic;
                min-height: 35px;
            }
            .message-input-area {
                padding: 15px 25px;
                background: white;
                border-top: 1px solid #e0e0e0;
            }
            .input-wrapper {
                display: flex;
                gap: 10px;
                align-items: center;
            }
            .input-wrapper input {
                flex: 1;
                padding: 12px 18px;
                border: 2px solid #e0e0e0;
                border-radius: 25px;
                font-size: 14px;
            }
            .input-wrapper input:focus {
                border-color: #667eea;
            }
            .send-btn {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
            }
            .empty-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: #999;
            }
            .empty-state-icon {
                font-size: 64px;
                margin-bottom: 20px;
                opacity: 0.5;
            }
            .empty-state-text {
                font-size: 18px;
            }
        </style>
    </head>
    <body>
        <div class="auth-container" id="authSection">
            <h1>ðŸ’¬ Chat</h1>
            <p>Connect to start messaging</p>
            <div class="auth-form">
                <input type="text" id="userId" placeholder="Enter your User ID" />
                <button onclick="connect()">Connect</button>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="chat-wrapper">
                <div class="sidebar">
                    <div class="sidebar-header">
                        <h2 id="userName">Loading...</h2>
                        <p>Select a project to start chatting</p>
                    </div>
                    <div class="project-selector">
                        <select id="projectSelect" onchange="onProjectChange()">
                            <option value="">Select a project...</option>
                        </select>
                    </div>
                    <div class="users-list" id="usersList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ‘¥</div>
                            <div class="empty-state-text">Select a project</div>
                        </div>
                    </div>
                </div>

                <div class="chat-area">
                    <div class="chat-header" id="chatHeader" style="display: none">
                        <div class="user-avatar" id="selectedUserAvatar">?</div>
                        <div class="chat-header-info">
                            <h3 id="selectedUserName">Select a user</h3>
                            <p id="selectedUserStatus"></p>
                        </div>
                    </div>
                    <div class="messages-container" id="messages">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ’¬</div>
                            <div class="empty-state-text">Select a user to start chatting</div>
                        </div>
                    </div>
                    <div class="typing-indicator" id="typingIndicator"></div>
                    <div class="message-input-area">
                        <div class="input-wrapper">
                            <input
                                type="text"
                                id="messageInput"
                                placeholder="Type a message..."
                                onkeyup="handleTyping()"
                                onkeypress="handleEnter(event)"
                                disabled
                            />
                            <button class="send-btn" onclick="sendMessage()" id="sendBtn" disabled>
                                âž¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let ws = null;
            let currentUserId = null;
            let currentUserName = null;
            let currentProjectId = null;
            let selectedUserId = null;
            let selectedUserName = null;
            let selectedUserOnline = false;
            let typingTimeout = null;
            let unreadCounts = {};
            let messageStatuses = {};
            let userStatuses = {};

            function connect() {
                const userId = document.getElementById('userId').value.trim();
                if (!userId) {
                    alert('Please enter your User ID');
                    return;
                }

                currentUserId = userId;
                ws = new WebSocket('ws://localhost:4000/chat');

                ws.onopen = () => {
                    ws.send(JSON.stringify({ type: 'auth', payload: { userId } }));
                };

                ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    handleMessage(message);
                };

                ws.onclose = () => {
                    document.getElementById('authSection').style.display = 'flex';
                    document.getElementById('chatContainer').style.display = 'none';
                };
            }

            function handleMessage(message) {
                switch (message.type) {
                    case 'auth_success':
                        currentUserName = message.payload.userName;
                        document.getElementById('userName').textContent = currentUserName;
                        document.getElementById('authSection').style.display = 'none';
                        document.getElementById('chatContainer').style.display = 'block';
                        loadUserProjects();
                        break;

                    case 'user_projects':
                        displayProjects(message.payload.projects);
                        break;

                    case 'project_users':
                        displayUsers(message.payload.users);
                        break;

                    case 'message_received':
                        if (message.payload.projectId === currentProjectId) {
                            const senderId = message.payload.sender_id;
                            if (
                                selectedUserId &&
                                (senderId === selectedUserId ||
                                    message.payload.receiver_id === selectedUserId)
                            ) {
                                displayMessage(message.payload);
                                if (senderId === selectedUserId) {
                                    setTimeout(() => {
                                        markMessagesAsRead([message.payload.id]);
                                    }, 500);
                                }
                            } else if (senderId !== currentUserId) {
                                unreadCounts[senderId] = (unreadCounts[senderId] || 0) + 1;
                                updateUnreadBadge(senderId);
                            }
                        }
                        break;

                    case 'message_history':
                        document.getElementById('messages').innerHTML = '';
                        const messageIds = [];
                        message.payload.messages.forEach((msg) => {
                            displayMessage(msg, true);
                            if (msg.sender_id === selectedUserId && msg.status !== 'READ') {
                                messageIds.push(msg.id);
                            }
                        });
                        if (messageIds.length > 0) {
                            markMessagesAsRead(messageIds);
                        }
                        break;

                    case 'message_read':
                        updateMessageStatus(message.payload.messageIds, 'READ');
                        break;

                    case 'user_online':
                        userStatuses[message.payload.userId] = { isOnline: true };
                        updateUserOnlineStatus(message.payload.userId, true);
                        break;

                    case 'user_offline':
                        userStatuses[message.payload.userId] = {
                            isOnline: false,
                            lastSeen: new Date(),
                        };
                        updateUserOnlineStatus(message.payload.userId, false);
                        break;

                    case 'typing_start':
                        if (message.payload.userId === selectedUserId) {
                            document.getElementById('typingIndicator').textContent = 'typing...';
                        }
                        break;

                    case 'typing_stop':
                        document.getElementById('typingIndicator').textContent = '';
                        break;
                }
            }

            function markMessagesAsRead(messageIds) {
                ws.send(
                    JSON.stringify({
                        type: 'mark_as_read',
                        payload: { messageIds },
                    }),
                );
            }

            function updateMessageStatus(messageIds, status) {
                messageIds.forEach((id) => {
                    const msgEl = document.querySelector(`[data-message-id="${id}"]`);
                    if (msgEl) {
                        const statusEl = msgEl.querySelector('.message-status');
                        if (statusEl) {
                            statusEl.textContent = getStatusIcon(status);
                            if (status === 'READ') {
                                statusEl.classList.add('read');
                            }
                        }
                    }
                });
            }

            function getStatusIcon(status) {
                if (status === 'READ') return 'âœ“âœ“';
                if (status === 'DELIVERED') return 'âœ“âœ“';
                return 'âœ“';
            }

            function getLastSeen(lastSeen) {
                if (!lastSeen) return 'Offline';
                const minutes = Math.floor((Date.now() - new Date(lastSeen)) / 60000);
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours}h ago`;
                return 'Yesterday';
            }

            function updateUserOnlineStatus(userId, isOnline) {
                const userItem = document.querySelector(`[data-user-id="${userId}"]`);
                if (userItem) {
                    const avatarEl = userItem.querySelector('.user-avatar');
                    const statusEl = userItem.querySelector('.user-status');

                    if (avatarEl) {
                        const existingDot = avatarEl.querySelector('.online-dot');
                        if (isOnline && !existingDot) {
                            avatarEl.insertAdjacentHTML(
                                'afterbegin',
                                '<span class="online-dot"></span>',
                            );
                        } else if (!isOnline && existingDot) {
                            existingDot.remove();
                        }
                    }

                    if (statusEl) {
                        if (isOnline) {
                            statusEl.textContent = 'Online';
                            statusEl.classList.remove('offline');
                        } else {
                            statusEl.textContent = getLastSeen(userStatuses[userId]?.lastSeen);
                            statusEl.classList.add('offline');
                        }
                    }
                }

                if (userId === selectedUserId) {
                    selectedUserOnline = isOnline;
                    const headerAvatar = document.getElementById('selectedUserAvatar');
                    const headerStatus = document.getElementById('selectedUserStatus');

                    if (headerAvatar) {
                        const existingDot = headerAvatar.querySelector('.online-dot');
                        if (isOnline && !existingDot) {
                            headerAvatar.insertAdjacentHTML(
                                'afterbegin',
                                '<span class="online-dot"></span>',
                            );
                        } else if (!isOnline && existingDot) {
                            existingDot.remove();
                        }
                    }

                    if (headerStatus) {
                        if (isOnline) {
                            headerStatus.textContent = 'Online';
                            headerStatus.classList.remove('offline');
                        } else {
                            headerStatus.textContent = getLastSeen(userStatuses[userId]?.lastSeen);
                            headerStatus.classList.add('offline');
                        }
                    }
                }
            }

            function updateAllLastSeenTimestamps() {
                Object.keys(userStatuses).forEach((userId) => {
                    if (!userStatuses[userId].isOnline) {
                        updateUserOnlineStatus(userId, false);
                    }
                });
            }

            setInterval(updateAllLastSeenTimestamps, 10000);

            function loadUserProjects() {
                ws.send(JSON.stringify({ type: 'get_user_projects', payload: {} }));
            }

            function displayProjects(projects) {
                const select = document.getElementById('projectSelect');
                select.innerHTML = '<option value="">Select a project...</option>';
                projects.forEach((project) => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = `${project.title} (${project.status})`;
                    select.appendChild(option);
                });
            }

            function onProjectChange() {
                const projectId = document.getElementById('projectSelect').value;
                if (!projectId) return;

                currentProjectId = projectId;
                selectedUserId = null;
                unreadCounts = {};
                document.getElementById('chatHeader').style.display = 'none';
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('messages').innerHTML =
                    '<div class="empty-state"><div class="empty-state-icon">ðŸ’¬</div><div class="empty-state-text">Select a user to start chatting</div></div>';

                ws.send(JSON.stringify({ type: 'get_project_users', payload: { projectId } }));
            }

            function displayUsers(users) {
                const container = document.getElementById('usersList');
                if (users.length === 0) {
                    container.innerHTML =
                        '<div class="empty-state"><div class="empty-state-icon">ðŸ‘¥</div><div class="empty-state-text">No users available</div></div>';
                    return;
                }

                container.innerHTML = users
                    .map((user) => {
                        userStatuses[user.id] = {
                            isOnline: user.isOnline,
                            lastSeen: user.lastSeen,
                        };
                        const statusText = user.isOnline ? 'Online' : getLastSeen(user.lastSeen);
                        const statusClass = user.isOnline ? '' : 'offline';

                        return `
                    <div class="user-item" data-user-id="${user.id}" onclick="selectUser('${user.id}', '${user.name}', '${user.role}', ${user.isOnline})">
                        <div class="user-avatar">
                            ${user.isOnline ? '<span class="online-dot"></span>' : ''}
                            ${user.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="user-info">
                            <div class="user-name">${user.name}</div>
                            <div class="user-status ${statusClass}">${statusText}</div>
                        </div>
                    </div>
                `;
                    })
                    .join('');
            }

            function updateUnreadBadge(userId) {
                const userItem = document.querySelector(`[data-user-id="${userId}"]`);
                if (!userItem) return;

                let badge = userItem.querySelector('.unread-badge');
                const count = unreadCounts[userId] || 0;

                if (count > 0) {
                    if (!badge) {
                        badge = document.createElement('div');
                        badge.className = 'unread-badge';
                        userItem.appendChild(badge);
                    }
                    badge.textContent = count > 99 ? '99+' : count;
                } else if (badge) {
                    badge.remove();
                }
            }

            function selectUser(userId, userName, userRole, isOnline) {
                selectedUserId = userId;
                selectedUserName = userName;

                // Get current online status from userStatuses instead of stale parameter
                const currentStatus = userStatuses[userId];
                selectedUserOnline = currentStatus ? currentStatus.isOnline : isOnline;

                unreadCounts[userId] = 0;
                updateUnreadBadge(userId);

                document
                    .querySelectorAll('.user-item')
                    .forEach((item) => item.classList.remove('active'));
                event.target.closest('.user-item').classList.add('active');

                document.getElementById('chatHeader').style.display = 'flex';

                // Use current status instead of stale parameter
                const isCurrentlyOnline = currentStatus ? currentStatus.isOnline : isOnline;
                document.getElementById('selectedUserAvatar').innerHTML = `
                ${isCurrentlyOnline ? '<span class="online-dot"></span>' : ''}
                ${userName.charAt(0).toUpperCase()}
            `;
                document.getElementById('selectedUserName').textContent = userName;

                const statusEl = document.getElementById('selectedUserStatus');
                const statusText = isCurrentlyOnline
                    ? 'Online'
                    : getLastSeen(currentStatus?.lastSeen);
                statusEl.textContent = statusText;
                statusEl.className = isCurrentlyOnline ? '' : 'offline';

                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('messages').innerHTML = '';

                ws.send(
                    JSON.stringify({
                        type: 'message_history',
                        payload: { projectId: currentProjectId, otherUserId: userId },
                    }),
                );
            }

            function sendMessage() {
                const content = document.getElementById('messageInput').value.trim();
                if (!content || !selectedUserId) return;

                ws.send(
                    JSON.stringify({
                        type: 'message_send',
                        payload: {
                            receiver_id: selectedUserId,
                            projectId: currentProjectId,
                            content,
                        },
                    }),
                );

                document.getElementById('messageInput').value = '';
                stopTyping();
            }

            function displayMessage(msg, isHistory = false) {
                const container = document.getElementById('messages');
                const messageEl = document.createElement('div');
                const isSent = msg.sender_id === currentUserId;
                messageEl.className = `message ${isSent ? 'sent' : 'received'}`;
                messageEl.setAttribute('data-message-id', msg.id);

                const statusIcon = isSent
                    ? `<span class="message-status ${msg.status === 'READ' ? 'read' : ''}">${getStatusIcon(msg.status)}</span>`
                    : '';

                messageEl.innerHTML = `
                <div class="message-content">${msg.content}</div>
                <div class="message-footer">
                    <span class="message-time">${new Date(msg.createdAt || msg.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}</span>
                    ${statusIcon}
                </div>
            `;
                container.appendChild(messageEl);
                if (!isHistory) container.scrollTop = container.scrollHeight;
            }

            function handleTyping() {
                if (!selectedUserId) return;
                if (typingTimeout) clearTimeout(typingTimeout);
                ws.send(
                    JSON.stringify({
                        type: 'typing_start',
                        payload: { projectId: currentProjectId },
                    }),
                );
                typingTimeout = setTimeout(stopTyping, 2000);
            }

            function stopTyping() {
                ws.send(
                    JSON.stringify({
                        type: 'typing_stop',
                        payload: { projectId: currentProjectId },
                    }),
                );
            }

            function handleEnter(event) {
                if (event.key === 'Enter') sendMessage();
            }
        </script>
    </body>
</html>
